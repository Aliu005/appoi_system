<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجز موعد - أمانة الأحساء</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
      import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

      // 🔥 Firebase Configuration - نفس الإعدادات من index-firebase.html
      const firebaseConfig = {
  apiKey: "AIzaSyCmv3l8_CKMjP1Wo3G7FpM4f6ox59gQb7g",
  authDomain: "test-one-6c755.firebaseapp.com",
  projectId: "test-one-6c755",
  storageBucket: "test-one-6c755.firebasestorage.app",
  messagingSenderId: "103909985339",
  appId: "1:103909985339:web:e827353eab071a76cca01e",
  measurementId: "G-41VG1LCE5L"
};

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      window.firebaseDB = db;
      window.collection = collection;
      window.addDoc = addDoc;
    </script>

    <style>
        /* نفس التصميم من الملف الأصلي */
        :root {
            --primary-color: #1a5f3f;
            --secondary-color: #d4af37;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #1a5f3f 0%, #2d7d5f 50%, #d4af37 100%);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius-xl: 24px;
        }

        * {
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
        }

        .booking-card {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 50px auto;
        }

        .card-header {
            background: var(--gradient-primary);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .card-header h2 {
            font-weight: 800;
            margin-bottom: 10px;
        }

        .form-control, .form-select {
            border: 2px solid rgba(26, 95, 63, 0.2);
            border-radius: 12px;
            padding: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 95, 63, 0.1);
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            padding: 15px 40px;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .alert {
            border: none;
            border-radius: 12px;
            padding: 20px;
        }

        .spinner-border {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="booking-card">
            <div class="card-header">
                <h2><i class="fas fa-calendar-plus me-3"></i>حجز موعد جديد</h2>
                <p class="mb-0">أمانة الأحساء - النظام الإلكتروني</p>
            </div>
            
            <div class="card-body p-4">
                <!-- رسائل التنبيه -->
                <div id="alertContainer"></div>
                
                <form id="bookingForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">رقم الهوية *</label>
                            <input type="text" class="form-control" id="nationalId" 
                                   placeholder="1234567890" maxlength="10" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">الاسم الكامل *</label>
                            <input type="text" class="form-control" id="fullName" 
                                   placeholder="الاسم الثلاثي" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">رقم الجوال *</label>
                            <input type="tel" class="form-control" id="phoneNumber" 
                                   placeholder="05xxxxxxxx" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">تاريخ الموعد المطلوب *</label>
                            <input type="date" class="form-control" id="appointmentDate" required>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-bold">سبب الموعد *</label>
                            <select class="form-select" id="appointmentReason" required>
                                <option value="">اختر سبب الموعد</option>
                                <option value="استخراج رخصة بناء">استخراج رخصة بناء</option>
                                <option value="تجديد ترخيص">تجديد ترخيص</option>
                                <option value="استخراج شهادة">استخراج شهادة</option>
                                <option value="شكوى على خدمة">شكوى على خدمة</option>
                                <option value="استعلام عن معاملة">استعلام عن معاملة</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-bold">الوصف التفصيلي</label>
                            <textarea class="form-control" id="reasonDescription" rows="4" 
                                      placeholder="اكتب وصفاً تفصيلياً لطلبك..."></textarea>
                        </div>
                        
                        <div class="col-12 text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                إرسال طلب الحجز
                            </button>
                        </div>
                        
                        <div class="col-12 text-center mt-3">
                            <a href="index-firebase.html" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-2"></i>
                                العودة للرئيسية
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>تم الحجز بنجاح
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-calendar-check fa-3x text-success"></i>
                    </div>
                    <h5>تم إرسال طلبك بنجاح!</h5>
                    <p class="text-muted">سيتم مراجعة طلبك والرد عليك في أقرب وقت</p>
                    <div class="alert alert-info">
                        <strong>رقم الطلب:</strong> <span id="appointmentId"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="location.reload()">
                        حجز موعد آخر
                    </button>
                    <a href="index-firebase.html" class="btn btn-outline-secondary">
                        العودة للرئيسية
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // تعيين الحد الأدنى للتاريخ (غداً)
        document.addEventListener('DOMContentLoaded', function() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('appointmentDate').min = tomorrow.toISOString().split('T')[0];
        });

        // معالجة إرسال النموذج
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // تغيير حالة الزر
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>جاري الإرسال...';
            
            try {
                // جمع البيانات
                const appointmentData = {
                    national_id: document.getElementById('nationalId').value,
                    full_name: document.getElementById('fullName').value,
                    phone_number: document.getElementById('phoneNumber').value,
                    appointment_date: document.getElementById('appointmentDate').value,
                    appointment_reason: document.getElementById('appointmentReason').value,
                    reason_description: document.getElementById('reasonDescription').value,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    admin_notes: null
                };
                
                // التحقق من صحة البيانات
                if (!validateForm(appointmentData)) {
                    throw new Error('يرجى التأكد من صحة البيانات المدخلة');
                }
                
                // حفظ في Firebase
                if (window.firebaseDB) {
                    const docRef = await window.addDoc(
                        window.collection(window.firebaseDB, 'appointments'), 
                        appointmentData
                    );
                    
                    // إظهار رسالة النجاح
                    document.getElementById('appointmentId').textContent = docRef.id;
                    const modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();
                    
                    // إعادة تعيين النموذج
                    document.getElementById('bookingForm').reset();
                    
                } else {
                    throw new Error('خطأ في الاتصال بقاعدة البيانات');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('حدث خطأ أثناء إرسال الطلب: ' + error.message, 'danger');
            } finally {
                // إعادة تعيين الزر
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // التحقق من صحة النموذج
        function validateForm(data) {
            // التحقق من رقم الهوية
            if (!/^\d{10}$/.test(data.national_id)) {
                showAlert('رقم الهوية يجب أن يكون 10 أرقام', 'danger');
                return false;
            }
            
            // التحقق من رقم الجوال
            if (!/^05\d{8}$/.test(data.phone_number)) {
                showAlert('رقم الجوال يجب أن يبدأ بـ 05 ويتكون من 10 أرقام', 'danger');
                return false;
            }
            
            // التحقق من التاريخ
            const selectedDate = new Date(data.appointment_date);
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (selectedDate < tomorrow) {
                showAlert('يجب أن يكون تاريخ الموعد غداً على الأقل', 'danger');
                return false;
            }
            
            return true;
        }

        // إظهار رسائل التنبيه
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            container.appendChild(alert);
            
            // إزالة تلقائية بعد 5 ثواني
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>